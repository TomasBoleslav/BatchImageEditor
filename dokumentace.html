<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>

<link href='https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext' rel='stylesheet' type='text/css' /><style type='text/css'>html {overflow-x: initial !important;}:root { --bg-color:#ffffff; --text-color:#333333; --select-text-bg-color:#B5D6FC; --select-text-font-color:auto; --monospace:"Lucida Console",Consolas,"Courier",monospace; --title-bar-height:20px; }
.mac-os-11 { --title-bar-height:28px; }
html { font-size: 14px; background-color: var(--bg-color); color: var(--text-color); font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; }
body { margin: 0px; padding: 0px; height: auto; inset: 0px; font-size: 1rem; line-height: 1.42857; overflow-x: hidden; background: inherit; tab-size: 4; }
iframe { margin: auto; }
a.url { word-break: break-all; }
a:active, a:hover { outline: 0px; }
.in-text-selection, ::selection { text-shadow: none; background: var(--select-text-bg-color); color: var(--select-text-font-color); }
#write { margin: 0px auto; height: auto; width: inherit; word-break: normal; overflow-wrap: break-word; position: relative; white-space: normal; overflow-x: visible; padding-top: 36px; }
#write.first-line-indent p { text-indent: 2em; }
#write.first-line-indent li p, #write.first-line-indent p * { text-indent: 0px; }
#write.first-line-indent li { margin-left: 2em; }
.for-image #write { padding-left: 8px; padding-right: 8px; }
body.typora-export { padding-left: 30px; padding-right: 30px; }
.typora-export .footnote-line, .typora-export li, .typora-export p { white-space: pre-wrap; }
.typora-export .task-list-item input { pointer-events: none; }
@media screen and (max-width: 500px) {
  body.typora-export { padding-left: 0px; padding-right: 0px; }
  #write { padding-left: 20px; padding-right: 20px; }
  .CodeMirror-sizer { margin-left: 0px !important; }
  .CodeMirror-gutters { display: none !important; }
}
#write li > figure:last-child { margin-bottom: 0.5rem; }
#write ol, #write ul { position: relative; }
img { max-width: 100%; vertical-align: middle; image-orientation: from-image; }
button, input, select, textarea { color: inherit; font: inherit; }
input[type="checkbox"], input[type="radio"] { line-height: normal; padding: 0px; }
*, ::after, ::before { box-sizing: border-box; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p, #write pre { width: inherit; }
#write h1, #write h2, #write h3, #write h4, #write h5, #write h6, #write p { position: relative; }
p { line-height: inherit; }
h1, h2, h3, h4, h5, h6 { break-after: avoid-page; break-inside: avoid; orphans: 4; }
p { orphans: 4; }
h1 { font-size: 2rem; }
h2 { font-size: 1.8rem; }
h3 { font-size: 1.6rem; }
h4 { font-size: 1.4rem; }
h5 { font-size: 1.2rem; }
h6 { font-size: 1rem; }
.md-math-block, .md-rawblock, h1, h2, h3, h4, h5, h6, p { margin-top: 1rem; margin-bottom: 1rem; }
.hidden { display: none; }
.md-blockmeta { color: rgb(204, 204, 204); font-weight: 700; font-style: italic; }
a { cursor: pointer; }
sup.md-footnote { padding: 2px 4px; background-color: rgba(238, 238, 238, 0.7); color: rgb(85, 85, 85); border-radius: 4px; cursor: pointer; }
sup.md-footnote a, sup.md-footnote a:hover { color: inherit; text-transform: inherit; text-decoration: inherit; }
#write input[type="checkbox"] { cursor: pointer; width: inherit; height: inherit; }
figure { overflow-x: auto; margin: 1.2em 0px; max-width: calc(100% + 16px); padding: 0px; }
figure > table { margin: 0px; }
tr { break-inside: avoid; break-after: auto; }
thead { display: table-header-group; }
table { border-collapse: collapse; border-spacing: 0px; width: 100%; overflow: auto; break-inside: auto; text-align: left; }
table.md-table td { min-width: 32px; }
.CodeMirror-gutters { border-right: 0px; background-color: inherit; }
.CodeMirror-linenumber { user-select: none; }
.CodeMirror { text-align: left; }
.CodeMirror-placeholder { opacity: 0.3; }
.CodeMirror pre { padding: 0px 4px; }
.CodeMirror-lines { padding: 0px; }
div.hr:focus { cursor: none; }
#write pre { white-space: pre-wrap; }
#write.fences-no-line-wrapping pre { white-space: pre; }
#write pre.ty-contain-cm { white-space: normal; }
.CodeMirror-gutters { margin-right: 4px; }
.md-fences { font-size: 0.9rem; display: block; break-inside: avoid; text-align: left; overflow: visible; white-space: pre; background: inherit; position: relative !important; }
.md-fences-adv-panel { width: 100%; margin-top: 10px; text-align: center; padding-top: 0px; padding-bottom: 8px; overflow-x: auto; }
#write .md-fences.mock-cm { white-space: pre-wrap; }
.md-fences.md-fences-with-lineno { padding-left: 0px; }
#write.fences-no-line-wrapping .md-fences.mock-cm { white-space: pre; overflow-x: auto; }
.md-fences.mock-cm.md-fences-with-lineno { padding-left: 8px; }
.CodeMirror-line, twitterwidget { break-inside: avoid; }
.footnotes { opacity: 0.8; font-size: 0.9rem; margin-top: 1em; margin-bottom: 1em; }
.footnotes + .footnotes { margin-top: 0px; }
.md-reset { margin: 0px; padding: 0px; border: 0px; outline: 0px; vertical-align: top; background: 0px 0px; text-decoration: none; text-shadow: none; float: none; position: static; width: auto; height: auto; white-space: nowrap; cursor: inherit; -webkit-tap-highlight-color: transparent; line-height: normal; font-weight: 400; text-align: left; box-sizing: content-box; direction: ltr; }
li div { padding-top: 0px; }
blockquote { margin: 1rem 0px; }
li .mathjax-block, li p { margin: 0.5rem 0px; }
li blockquote { margin: 1rem 0px; }
li { margin: 0px; position: relative; }
blockquote > :last-child { margin-bottom: 0px; }
blockquote > :first-child, li > :first-child { margin-top: 0px; }
.footnotes-area { color: rgb(136, 136, 136); margin-top: 0.714rem; padding-bottom: 0.143rem; white-space: normal; }
#write .footnote-line { white-space: pre-wrap; }
@media print {
  body, html { border: 1px solid transparent; height: 99%; break-after: avoid; break-before: avoid; font-variant-ligatures: no-common-ligatures; }
  #write { margin-top: 0px; padding-top: 0px; border-color: transparent !important; }
  .typora-export * { -webkit-print-color-adjust: exact; }
  .typora-export #write { break-after: avoid; }
  .typora-export #write::after { height: 0px; }
  .is-mac table { break-inside: avoid; }
  .typora-export-show-outline .typora-export-sidebar { display: none; }
}
.footnote-line { margin-top: 0.714em; font-size: 0.7em; }
a img, img a { cursor: pointer; }
pre.md-meta-block { font-size: 0.8rem; min-height: 0.8rem; white-space: pre-wrap; background: rgb(204, 204, 204); display: block; overflow-x: hidden; }
p > .md-image:only-child:not(.md-img-error) img, p > img:only-child { display: block; margin: auto; }
#write.first-line-indent p > .md-image:only-child:not(.md-img-error) img { left: -2em; position: relative; }
p > .md-image:only-child { display: inline-block; width: 100%; }
#write .MathJax_Display { margin: 0.8em 0px 0px; }
.md-math-block { width: 100%; }
.md-math-block:not(:empty)::after { display: none; }
.MathJax_ref { fill: currentcolor; }
[contenteditable="true"]:active, [contenteditable="true"]:focus, [contenteditable="false"]:active, [contenteditable="false"]:focus { outline: 0px; box-shadow: none; }
.md-task-list-item { position: relative; list-style-type: none; }
.task-list-item.md-task-list-item { padding-left: 0px; }
.md-task-list-item > input { position: absolute; top: 0px; left: 0px; margin-left: -1.2em; margin-top: calc(1em - 10px); border: none; }
.math { font-size: 1rem; }
.md-toc { min-height: 3.58rem; position: relative; font-size: 0.9rem; border-radius: 10px; }
.md-toc-content { position: relative; margin-left: 0px; }
.md-toc-content::after, .md-toc::after { display: none; }
.md-toc-item { display: block; color: rgb(65, 131, 196); }
.md-toc-item a { text-decoration: none; }
.md-toc-inner:hover { text-decoration: underline; }
.md-toc-inner { display: inline-block; cursor: pointer; }
.md-toc-h1 .md-toc-inner { margin-left: 0px; font-weight: 700; }
.md-toc-h2 .md-toc-inner { margin-left: 2em; }
.md-toc-h3 .md-toc-inner { margin-left: 4em; }
.md-toc-h4 .md-toc-inner { margin-left: 6em; }
.md-toc-h5 .md-toc-inner { margin-left: 8em; }
.md-toc-h6 .md-toc-inner { margin-left: 10em; }
@media screen and (max-width: 48em) {
  .md-toc-h3 .md-toc-inner { margin-left: 3.5em; }
  .md-toc-h4 .md-toc-inner { margin-left: 5em; }
  .md-toc-h5 .md-toc-inner { margin-left: 6.5em; }
  .md-toc-h6 .md-toc-inner { margin-left: 8em; }
}
a.md-toc-inner { font-size: inherit; font-style: inherit; font-weight: inherit; line-height: inherit; }
.footnote-line a:not(.reversefootnote) { color: inherit; }
.md-attr { display: none; }
.md-fn-count::after { content: "."; }
code, pre, samp, tt { font-family: var(--monospace); }
kbd { margin: 0px 0.1em; padding: 0.1em 0.6em; font-size: 0.8em; color: rgb(36, 39, 41); background: rgb(255, 255, 255); border: 1px solid rgb(173, 179, 185); border-radius: 3px; box-shadow: rgba(12, 13, 14, 0.2) 0px 1px 0px, rgb(255, 255, 255) 0px 0px 0px 2px inset; white-space: nowrap; vertical-align: middle; }
.md-comment { color: rgb(162, 127, 3); opacity: 0.8; font-family: var(--monospace); }
code { text-align: left; vertical-align: initial; }
a.md-print-anchor { white-space: pre !important; border-width: initial !important; border-style: none !important; border-color: initial !important; display: inline-block !important; position: absolute !important; width: 1px !important; right: 0px !important; outline: 0px !important; background: 0px 0px !important; text-decoration: initial !important; text-shadow: initial !important; }
.os-windows.monocolor-emoji .md-emoji { font-family: "Segoe UI Symbol", sans-serif; }
.md-diagram-panel > svg { max-width: 100%; }
[lang="flow"] svg, [lang="mermaid"] svg { max-width: 100%; height: auto; }
[lang="mermaid"] .node text { font-size: 1rem; }
table tr th { border-bottom: 0px; }
video { max-width: 100%; display: block; margin: 0px auto; }
iframe { max-width: 100%; width: 100%; border: none; }
.highlight td, .highlight tr { border: 0px; }
mark { background: rgb(255, 255, 0); color: rgb(0, 0, 0); }
.md-html-inline .md-plain, .md-html-inline strong, mark .md-inline-math, mark strong { color: inherit; }
.md-expand mark .md-meta { opacity: 0.3 !important; }
mark .md-meta { color: rgb(0, 0, 0); }
@media print {
  .typora-export h1, .typora-export h2, .typora-export h3, .typora-export h4, .typora-export h5, .typora-export h6 { break-inside: avoid; }
}
.md-diagram-panel .messageText { stroke: none !important; }
.md-diagram-panel .start-state { fill: var(--node-fill); }
.md-diagram-panel .edgeLabel rect { opacity: 1 !important; }
.md-require-zoom-fix { height: auto; margin-top: 16px; margin-bottom: 16px; }
.md-require-zoom-fix foreignobject { font-size: var(--mermaid-font-zoom); }
.md-fences.md-fences-math { font-size: 1em; }
.md-fences-advanced:not(.md-focus) { padding: 0px; white-space: nowrap; border: 0px; }
.md-fences-advanced:not(.md-focus) { background: inherit; }
.typora-export-show-outline .typora-export-content { max-width: 1440px; margin: auto; display: flex; flex-direction: row; }
.typora-export-sidebar { width: 300px; font-size: 0.8rem; margin-top: 80px; margin-right: 18px; }
.typora-export-show-outline #write { --webkit-flex:2; flex: 2 1 0%; }
.typora-export-sidebar .outline-content { position: fixed; top: 0px; max-height: 100%; overflow: hidden auto; padding-bottom: 30px; padding-top: 60px; width: 300px; }
@media screen and (max-width: 1024px) {
  .typora-export-sidebar, .typora-export-sidebar .outline-content { width: 240px; }
}
@media screen and (max-width: 800px) {
  .typora-export-sidebar { display: none; }
}
.outline-content li, .outline-content ul { margin-left: 0px; margin-right: 0px; padding-left: 0px; padding-right: 0px; list-style: none; }
.outline-content ul { margin-top: 0px; margin-bottom: 0px; }
.outline-content strong { font-weight: 400; }
.outline-expander { width: 1rem; height: 1.42857rem; position: relative; display: table-cell; vertical-align: middle; cursor: pointer; padding-left: 4px; }
.outline-expander::before { content: ""; position: relative; font-family: Ionicons; display: inline-block; font-size: 8px; vertical-align: middle; }
.outline-item { padding-top: 3px; padding-bottom: 3px; cursor: pointer; }
.outline-expander:hover::before { content: ""; }
.outline-h1 > .outline-item { padding-left: 0px; }
.outline-h2 > .outline-item { padding-left: 1em; }
.outline-h3 > .outline-item { padding-left: 2em; }
.outline-h4 > .outline-item { padding-left: 3em; }
.outline-h5 > .outline-item { padding-left: 4em; }
.outline-h6 > .outline-item { padding-left: 5em; }
.outline-label { cursor: pointer; display: table-cell; vertical-align: middle; text-decoration: none; color: inherit; }
.outline-label:hover { text-decoration: underline; }
.outline-item:hover { border-color: rgb(245, 245, 245); background-color: var(--item-hover-bg-color); }
.outline-item:hover { margin-left: -28px; margin-right: -28px; border-left: 28px solid transparent; border-right: 28px solid transparent; }
.outline-item-single .outline-expander::before, .outline-item-single .outline-expander:hover::before { display: none; }
.outline-item-open > .outline-item > .outline-expander::before { content: ""; }
.outline-children { display: none; }
.info-panel-tab-wrapper { display: none; }
.outline-item-open > .outline-children { display: block; }
.typora-export .outline-item { padding-top: 1px; padding-bottom: 1px; }
.typora-export .outline-item:hover { margin-right: -8px; border-right: 8px solid transparent; }
.typora-export .outline-expander::before { content: "+"; font-family: inherit; top: -1px; }
.typora-export .outline-expander:hover::before, .typora-export .outline-item-open > .outline-item > .outline-expander::before { content: "−"; }
.typora-export-collapse-outline .outline-children { display: none; }
.typora-export-collapse-outline .outline-item-open > .outline-children, .typora-export-no-collapse-outline .outline-children { display: block; }
.typora-export-no-collapse-outline .outline-expander::before { content: "" !important; }
.typora-export-show-outline .outline-item-active > .outline-item .outline-label { font-weight: 700; }
.md-inline-math-container mjx-container { zoom: 0.95; }


.CodeMirror { height: auto; }
.CodeMirror.cm-s-inner { background: inherit; }
.CodeMirror-scroll { overflow: auto hidden; z-index: 3; }
.CodeMirror-gutter-filler, .CodeMirror-scrollbar-filler { background-color: rgb(255, 255, 255); }
.CodeMirror-gutters { border-right: 1px solid rgb(221, 221, 221); background: inherit; white-space: nowrap; }
.CodeMirror-linenumber { padding: 0px 3px 0px 5px; text-align: right; color: rgb(153, 153, 153); }
.cm-s-inner .cm-keyword { color: rgb(119, 0, 136); }
.cm-s-inner .cm-atom, .cm-s-inner.cm-atom { color: rgb(34, 17, 153); }
.cm-s-inner .cm-number { color: rgb(17, 102, 68); }
.cm-s-inner .cm-def { color: rgb(0, 0, 255); }
.cm-s-inner .cm-variable { color: rgb(0, 0, 0); }
.cm-s-inner .cm-variable-2 { color: rgb(0, 85, 170); }
.cm-s-inner .cm-variable-3 { color: rgb(0, 136, 85); }
.cm-s-inner .cm-string { color: rgb(170, 17, 17); }
.cm-s-inner .cm-property { color: rgb(0, 0, 0); }
.cm-s-inner .cm-operator { color: rgb(152, 26, 26); }
.cm-s-inner .cm-comment, .cm-s-inner.cm-comment { color: rgb(170, 85, 0); }
.cm-s-inner .cm-string-2 { color: rgb(255, 85, 0); }
.cm-s-inner .cm-meta { color: rgb(85, 85, 85); }
.cm-s-inner .cm-qualifier { color: rgb(85, 85, 85); }
.cm-s-inner .cm-builtin { color: rgb(51, 0, 170); }
.cm-s-inner .cm-bracket { color: rgb(153, 153, 119); }
.cm-s-inner .cm-tag { color: rgb(17, 119, 0); }
.cm-s-inner .cm-attribute { color: rgb(0, 0, 204); }
.cm-s-inner .cm-header, .cm-s-inner.cm-header { color: rgb(0, 0, 255); }
.cm-s-inner .cm-quote, .cm-s-inner.cm-quote { color: rgb(0, 153, 0); }
.cm-s-inner .cm-hr, .cm-s-inner.cm-hr { color: rgb(153, 153, 153); }
.cm-s-inner .cm-link, .cm-s-inner.cm-link { color: rgb(0, 0, 204); }
.cm-negative { color: rgb(221, 68, 68); }
.cm-positive { color: rgb(34, 153, 34); }
.cm-header, .cm-strong { font-weight: 700; }
.cm-del { text-decoration: line-through; }
.cm-em { font-style: italic; }
.cm-link { text-decoration: underline; }
.cm-error { color: red; }
.cm-invalidchar { color: red; }
.cm-constant { color: rgb(38, 139, 210); }
.cm-defined { color: rgb(181, 137, 0); }
div.CodeMirror span.CodeMirror-matchingbracket { color: rgb(0, 255, 0); }
div.CodeMirror span.CodeMirror-nonmatchingbracket { color: rgb(255, 34, 34); }
.cm-s-inner .CodeMirror-activeline-background { background: inherit; }
.CodeMirror { position: relative; overflow: hidden; }
.CodeMirror-scroll { height: 100%; outline: 0px; position: relative; box-sizing: content-box; background: inherit; }
.CodeMirror-sizer { position: relative; }
.CodeMirror-gutter-filler, .CodeMirror-hscrollbar, .CodeMirror-scrollbar-filler, .CodeMirror-vscrollbar { position: absolute; z-index: 6; display: none; outline: 0px; }
.CodeMirror-vscrollbar { right: 0px; top: 0px; overflow: hidden; }
.CodeMirror-hscrollbar { bottom: 0px; left: 0px; overflow: auto hidden; }
.CodeMirror-scrollbar-filler { right: 0px; bottom: 0px; }
.CodeMirror-gutter-filler { left: 0px; bottom: 0px; }
.CodeMirror-gutters { position: absolute; left: 0px; top: 0px; padding-bottom: 10px; z-index: 3; overflow-y: hidden; }
.CodeMirror-gutter { white-space: normal; height: 100%; box-sizing: content-box; padding-bottom: 30px; margin-bottom: -32px; display: inline-block; }
.CodeMirror-gutter-wrapper { position: absolute; z-index: 4; background: 0px 0px !important; border: none !important; }
.CodeMirror-gutter-background { position: absolute; top: 0px; bottom: 0px; z-index: 4; }
.CodeMirror-gutter-elt { position: absolute; cursor: default; z-index: 4; }
.CodeMirror-lines { cursor: text; }
.CodeMirror pre { border-radius: 0px; border-width: 0px; background: 0px 0px; font-family: inherit; font-size: inherit; margin: 0px; white-space: pre; overflow-wrap: normal; color: inherit; z-index: 2; position: relative; overflow: visible; }
.CodeMirror-wrap pre { overflow-wrap: break-word; white-space: pre-wrap; word-break: normal; }
.CodeMirror-code pre { border-right: 30px solid transparent; width: fit-content; }
.CodeMirror-wrap .CodeMirror-code pre { border-right: none; width: auto; }
.CodeMirror-linebackground { position: absolute; inset: 0px; z-index: 0; }
.CodeMirror-linewidget { position: relative; z-index: 2; overflow: auto; }
.CodeMirror-wrap .CodeMirror-scroll { overflow-x: hidden; }
.CodeMirror-measure { position: absolute; width: 100%; height: 0px; overflow: hidden; visibility: hidden; }
.CodeMirror-measure pre { position: static; }
.CodeMirror div.CodeMirror-cursor { position: absolute; visibility: hidden; border-right: none; width: 0px; }
.CodeMirror div.CodeMirror-cursor { visibility: hidden; }
.CodeMirror-focused div.CodeMirror-cursor { visibility: inherit; }
.cm-searching { background: rgba(255, 255, 0, 0.4); }
span.cm-underlined { text-decoration: underline; }
span.cm-strikethrough { text-decoration: line-through; }
.cm-tw-syntaxerror { color: rgb(255, 255, 255); background-color: rgb(153, 0, 0); }
.cm-tw-deleted { text-decoration: line-through; }
.cm-tw-header5 { font-weight: 700; }
.cm-tw-listitem:first-child { padding-left: 10px; }
.cm-tw-box { border-style: solid; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-color: inherit; border-top-width: 0px !important; }
.cm-tw-underline { text-decoration: underline; }
@media print {
  .CodeMirror div.CodeMirror-cursor { visibility: hidden; }
}


:root {
    --side-bar-bg-color: #fafafa;
    --control-text-color: #777;
}

@include-when-export url(https://fonts.loli.net/css?family=Open+Sans:400italic,700italic,700,400&subset=latin,latin-ext);

/* open-sans-regular - latin-ext_latin */
  /* open-sans-italic - latin-ext_latin */
    /* open-sans-700 - latin-ext_latin */
    /* open-sans-700italic - latin-ext_latin */
  html {
    font-size: 16px;
    -webkit-font-smoothing: antialiased;
}

body {
    font-family: "Open Sans","Clear Sans", "Helvetica Neue", Helvetica, Arial, 'Segoe UI Emoji', sans-serif;
    color: rgb(51, 51, 51);
    line-height: 1.6;
}

#write {
    max-width: 860px;
  	margin: 0 auto;
  	padding: 30px;
    padding-bottom: 100px;
}

@media only screen and (min-width: 1400px) {
	#write {
		max-width: 1024px;
	}
}

@media only screen and (min-width: 1800px) {
	#write {
		max-width: 1200px;
	}
}

#write > ul:first-child,
#write > ol:first-child{
    margin-top: 30px;
}

a {
    color: #4183C4;
}
h1,
h2,
h3,
h4,
h5,
h6 {
    position: relative;
    margin-top: 1rem;
    margin-bottom: 1rem;
    font-weight: bold;
    line-height: 1.4;
    cursor: text;
}
h1:hover a.anchor,
h2:hover a.anchor,
h3:hover a.anchor,
h4:hover a.anchor,
h5:hover a.anchor,
h6:hover a.anchor {
    text-decoration: none;
}
h1 tt,
h1 code {
    font-size: inherit;
}
h2 tt,
h2 code {
    font-size: inherit;
}
h3 tt,
h3 code {
    font-size: inherit;
}
h4 tt,
h4 code {
    font-size: inherit;
}
h5 tt,
h5 code {
    font-size: inherit;
}
h6 tt,
h6 code {
    font-size: inherit;
}
h1 {
    font-size: 2.25em;
    line-height: 1.2;
    border-bottom: 1px solid #eee;
}
h2 {
    font-size: 1.75em;
    line-height: 1.225;
    border-bottom: 1px solid #eee;
}

/*@media print {
    .typora-export h1,
    .typora-export h2 {
        border-bottom: none;
        padding-bottom: initial;
    }

    .typora-export h1::after,
    .typora-export h2::after {
        content: "";
        display: block;
        height: 100px;
        margin-top: -96px;
        border-top: 1px solid #eee;
    }
}*/

h3 {
    font-size: 1.5em;
    line-height: 1.43;
}
h4 {
    font-size: 1.25em;
}
h5 {
    font-size: 1em;
}
h6 {
   font-size: 1em;
    color: #777;
}
p,
blockquote,
ul,
ol,
dl,
table{
    margin: 0.8em 0;
}
li>ol,
li>ul {
    margin: 0 0;
}
hr {
    height: 2px;
    padding: 0;
    margin: 16px 0;
    background-color: #e7e7e7;
    border: 0 none;
    overflow: hidden;
    box-sizing: content-box;
}

li p.first {
    display: inline-block;
}
ul,
ol {
    padding-left: 30px;
}
ul:first-child,
ol:first-child {
    margin-top: 0;
}
ul:last-child,
ol:last-child {
    margin-bottom: 0;
}
blockquote {
    border-left: 4px solid #dfe2e5;
    padding: 0 15px;
    color: #777777;
}
blockquote blockquote {
    padding-right: 0;
}
table {
    padding: 0;
    word-break: initial;
}
table tr {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 0;
}
table tr:nth-child(2n),
thead {
    background-color: #f8f8f8;
}
table th {
    font-weight: bold;
    border: 1px solid #dfe2e5;
    border-bottom: 0;
    margin: 0;
    padding: 6px 13px;
}
table td {
    border: 1px solid #dfe2e5;
    margin: 0;
    padding: 6px 13px;
}
table th:first-child,
table td:first-child {
    margin-top: 0;
}
table th:last-child,
table td:last-child {
    margin-bottom: 0;
}

.CodeMirror-lines {
    padding-left: 4px;
}

.code-tooltip {
    box-shadow: 0 1px 1px 0 rgba(0,28,36,.3);
    border-top: 1px solid #eef2f2;
}

.md-fences,
code,
tt {
    border: 1px solid #e7eaed;
    background-color: #f8f8f8;
    border-radius: 3px;
    padding: 0;
    padding: 2px 4px 0px 4px;
    font-size: 0.9em;
}

code {
    background-color: #f3f4f4;
    padding: 0 2px 0 2px;
}

.md-fences {
    margin-bottom: 15px;
    margin-top: 15px;
    padding-top: 8px;
    padding-bottom: 6px;
}


.md-task-list-item > input {
  margin-left: -1.3em;
}

@media print {
    html {
        font-size: 13px;
    }
    table,
    pre {
        page-break-inside: avoid;
    }
    pre {
        word-wrap: break-word;
    }
}

.md-fences {
	background-color: #f8f8f8;
}
#write pre.md-meta-block {
	padding: 1rem;
    font-size: 85%;
    line-height: 1.45;
    background-color: #f7f7f7;
    border: 0;
    border-radius: 3px;
    color: #777777;
    margin-top: 0 !important;
}

.mathjax-block>.code-tooltip {
	bottom: .375rem;
}

.md-mathjax-midline {
    background: #fafafa;
}

#write>h3.md-focus:before{
	left: -1.5625rem;
	top: .375rem;
}
#write>h4.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h5.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
#write>h6.md-focus:before{
	left: -1.5625rem;
	top: .285714286rem;
}
.md-image>.md-meta {
    /*border: 1px solid #ddd;*/
    border-radius: 3px;
    padding: 2px 0px 0px 4px;
    font-size: 0.9em;
    color: inherit;
}

.md-tag {
    color: #a7a7a7;
    opacity: 1;
}

.md-toc { 
    margin-top:20px;
    padding-bottom:20px;
}

.sidebar-tabs {
    border-bottom: none;
}

#typora-quick-open {
    border: 1px solid #ddd;
    background-color: #f8f8f8;
}

#typora-quick-open-item {
    background-color: #FAFAFA;
    border-color: #FEFEFE #e5e5e5 #e5e5e5 #eee;
    border-style: solid;
    border-width: 1px;
}

/** focus mode */
.on-focus-mode blockquote {
    border-left-color: rgba(85, 85, 85, 0.12);
}

header, .context-menu, .megamenu-content, footer{
    font-family: "Segoe UI", "Arial", sans-serif;
}

.file-node-content:hover .file-node-icon,
.file-node-content:hover .file-node-open-state{
    visibility: visible;
}

.mac-seamless-mode #typora-sidebar {
    background-color: #fafafa;
    background-color: var(--side-bar-bg-color);
}

.md-lang {
    color: #b4654d;
}

/*.html-for-mac {
    --item-hover-bg-color: #E6F0FE;
}*/

#md-notification .btn {
    border: 0;
}

.dropdown-menu .divider {
    border-color: #e5e5e5;
    opacity: 0.4;
}

.ty-preferences .window-content {
    background-color: #fafafa;
}

.ty-preferences .nav-group-item.active {
    color: white;
    background: #999;
}

.menu-item-container a.menu-style-btn {
    background-color: #f5f8fa;
    background-image: linear-gradient( 180deg , hsla(0, 0%, 100%, 0.8), hsla(0, 0%, 100%, 0)); 
}



</style><title>README</title>
</head>
<body class='typora-export os-windows'><div class='typora-export-content'>
<div id='write'  class=''><h1 id='batchimageeditor'><span>BatchImageEditor</span></h1><p><strong><span>BatchImageEditor</span></strong><span> je jednoduchý editor pro větší množství obrázků najednou. Nahrajete své obrázky, zvolíte některé z nabídnutých úprav a necháte program obrázky zpracovat. Aby byl celý proces rychlejší, umožňuje aplikace spouštět výpočet paralelně.</span></p><p><span>Program je napsán v jazyce C# jako okenní </span><em><span>Windows Forms</span></em><span> aplikace.</span></p><h2 id='obsah'><span>Obsah</span></h2><ul><li><p><a href='#sestavení'><span>Sestavení</span></a></p></li><li><p><a href='#návod-k-použití'><span>Návod k použití</span></a></p><ul><li><a href='#načtení-obrázků'><span>Načtení obrázků</span></a></li><li><a href='#úprava-obrázků'><span>Úprava obrázků</span></a></li><li><a href='#zpracování'><span>Zpracování</span></a></li></ul></li><li><p><a href='#vývojová-dokumentace'><span>Vývojová dokumentace</span></a></p><ul><li><a href='#struktura-programu'><span>Struktura programu</span></a></li><li><a href='#projekt-imagefilters'><span>Projekt ImageFilters</span></a></li><li><a href='#projekt-batchimageeditor'><span>Projekt BatchImageEditor</span></a></li></ul></li><li><p><a href='#pohled-zpět-a-možná-vylepšení'><span>Pohled zpět a možná vylepšení</span></a></p></li></ul><h2 id='sestavení'><span>Sestavení</span></h2><p><span>Sestavení programu můžete provést ve </span><em><span>Visual Studiu</span></em><span> nebo pomocí příkazové řádky:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="powershell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="powershell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">&gt;</span> <span class="cm-identifier">dotnet</span> <span class="cm-identifier">build</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p><span>Testy můžete spustit příkazem:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="powershell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="powershell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">&gt;</span> <span class="cm-identifier">dotnet</span> <span class="cm-identifier">test</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><h2 id='návod-k-použití'><span>Návod k použití</span></h2><p><span>Program spustíte otevřením výsledného </span><code>*.exe</code><span> souboru po sestavení nebo pomocí příkazové řádky:</span></p><pre class="md-fences md-end-block ty-contain-cm modeLoaded" spellcheck="false" lang="powershell"><div class="CodeMirror cm-s-inner cm-s-null-scroll CodeMirror-wrap" lang="powershell"><div style="overflow: hidden; position: relative; width: 3px; height: 0px; top: 9.5px; left: 8px;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; bottom: -1em; padding: 0px; width: 1000px; height: 1em; outline: none;"></textarea></div><div class="CodeMirror-scrollbar-filler" cm-not-content="true"></div><div class="CodeMirror-gutter-filler" cm-not-content="true"></div><div class="CodeMirror-scroll" tabindex="-1"><div class="CodeMirror-sizer" style="margin-left: 0px; margin-bottom: 0px; border-right-width: 0px; padding-right: 0px; padding-bottom: 0px;"><div style="position: relative; top: 0px;"><div class="CodeMirror-lines" role="presentation"><div role="presentation" style="position: relative; outline: none;"><div class="CodeMirror-measure"><pre><span>xxxxxxxxxx</span></pre></div><div class="CodeMirror-measure"></div><div style="position: relative; z-index: 1;"></div><div class="CodeMirror-code" role="presentation"><div class="CodeMirror-activeline" style="position: relative;"><div class="CodeMirror-activeline-background CodeMirror-linebackground"></div><div class="CodeMirror-gutter-background CodeMirror-activeline-gutter" style="left: 0px; width: 0px;"></div><pre class=" CodeMirror-line " role="presentation"><span role="presentation" style="padding-right: 0.1px;"><span class="cm-operator">&gt;</span> <span class="cm-identifier">dotnet</span> <span class="cm-identifier">run</span></span></pre></div></div></div></div></div></div><div style="position: absolute; height: 0px; width: 1px; border-bottom: 0px solid transparent; top: 23px;"></div><div class="CodeMirror-gutters" style="display: none; height: 23px;"></div></div></div></pre><p><span>Otevře se okno editoru se scénou pro načítání obrázků.</span></p><p><img src="./ReadmeResources/load-scene.png" referrerpolicy="no-referrer" alt="load-scene"></p><p><span>Na vrchní části okna se nacházejí tlačítka pro změnu scény. Kliknutím na některé z nich můžete kdykoliv přepnout mezi scénou pro načítání obrázků (</span><strong><span>LOAD</span></strong><span>), jejich úpravu (</span><strong><span>EDIT</span></strong><span>) a konečné zpracování (</span><strong><span>PROCESS</span></strong><span>).</span></p><h3 id='načtení-obrázků'><span>Načtení obrázků</span></h3><p><span>Načítání souborů probíhá ve scéně </span><strong><span>LOAD</span></strong><span>. </span></p><p><img src="./ReadmeResources/load-scene-with-images.png" referrerpolicy="no-referrer" alt="load-scene-with-images"></p><p><span>Obrázky můžete načíst jednotlivě tlačítkem </span><strong><span>Load images</span></strong><span> nebo jako celou složku tlačítkem </span><strong><span>Load folder</span></strong><span>. Informace o souborech se pak objeví v seznamu nalevo. Pokud některý ze souborů v seznamu označíte, ukáže se náhled obrázku vpravo dole. Označené soubory můžete odebrat ze seznamu tlačítkem </span><strong><span>Remove</span></strong><span>.</span></p><p><span>Mezi </span><strong><span>podporované formáty</span></strong><span> obrázku patří JPEG, PNG, BMP a GIF.</span></p><h3 id='úprava-obrázků'><span>Úprava obrázků</span></h3><p><span>K úpravě obrázků slouží scéna </span><strong><span>EDIT</span></strong><span>.</span></p><p><img src="./ReadmeResources/edit-scene.png" referrerpolicy="no-referrer" alt="edit-scene"></p><p><span>V levé části okna můžete upravovat seznam filtrů. Pro přidání filtru použijte tlačítko </span><strong><span>Add</span></strong><span> a v zobrazeném menu vyberte požadovaný filtr. Označené položky můžete odebrat pomocí tlačítka </span><strong><span>Remove</span></strong><span> nebo upravit kliknutím na </span><strong><span>Edit</span></strong><span>. Pokud filtr nechcete odstranit, ale pouze vynechat z výpočtu, využijte zaškrtávacího tlačítka vedle názvu položky. Jednotlivými filtry můžete v seznamu posouvat nahoru a dolů pomocí tlačítek s šipkami, čímž změníte pořadí jejich vykonávání. Filtry se na obrázek aplikují vždy v pořadí shora dolů.</span></p><p><span>V pravé části okna je náhled obrázku. Obrázek pro náhled můžete zvolit na vysouvací liště v horní části. Mezi původním a zpracovaným obrázkem můžete přepínat tlačítkem </span><strong><span>Show original</span></strong><span> / </span><strong><span>Show preview</span></strong><span>. Pro zobrazení náhledu jsou dvě volby </span><strong><span>Fit</span></strong><span> (natáhnutí obrázku na velikost plochy) a </span><strong><span>Center</span></strong><span> (zobrazení obrázku doprostřed plochy v originální velikosti).</span></p><p><span>Při výběru nového filtru pomocí </span><strong><span>Add</span></strong><span> nebo úpravy existujícího pomocí </span><strong><span>Edit</span></strong><span> se zobrazí okno pro nastavení filtru. Například pro filtr </span><strong><span>Flip</span></strong><span> vypadá nastavení následovně:</span></p><p><img src="./ReadmeResources/flip-filter-settings.png" referrerpolicy="no-referrer" alt="flip-filter-settings"></p><p><span>V levé části je náhled obrázku, v pravé je nastavení filtru. Položky nastavení se pro každý filtr liší. Pro </span><strong><span>Flip</span></strong><span> je to typ převrácení, pro </span><strong><span>Channels</span></strong><span> je to změna jednotlivých barevných kanálů, atd.</span></p><p><span>Kliknutím na </span><strong><span>Ok</span></strong><span> se filtr s daným nastavením přidá do seznamu. Pomocí </span><strong><span>Reset</span></strong><span> se nastavení změní zpět na výchozí. Zavřením okna volbu zrušíte a změny nebudou uloženy.</span></p><h3 id='zpracování'><span>Zpracování</span></h3><p><span>Ve scéně </span><strong><span>Process</span></strong><span> se nastavuje a provádí finální zpracování obrázků.</span></p><p><img src="./ReadmeResources/process-scene.png" referrerpolicy="no-referrer" alt="process-scene"></p><p><span>Zvolte cestu k výstupní složce pomocí tlačítka </span><strong><span>Select</span></strong><span>, nebo ji napište přímo do vstupního pole. Nastavit můžete i maximální počet vláken, který se použije na výpočet. Ve výchozím nastavení je zaškrtnuté </span><strong><span>Use Core Count</span></strong><span>, což znamená, že se použije stejný počet vláken, jako je počet jader procesoru na daném počítači. Odškrtnutím se povolí zápis do pole </span><strong><span>Thread Count</span></strong><span>, kde můžete nastavit počet vláken manuálně. Maximum je však dvojnásobek celkového počtu jader. Pokud zvolíte pouze 1 vlákno, výpočet bude probíhat sekvenčně a reakce editoru se velmi zpomalí.</span></p><p><span>Kliknutím na </span><strong><span>Process</span></strong><span> se zahájí výpočet a otevře se nové okno s detaily:</span></p><p><img src="./ReadmeResources/image-processing-dialog.png" referrerpolicy="no-referrer" alt="image-processing-dialog"></p><p><span>Ve vrchní části okna můžete sledovat postup. Proces můžete kdykoliv přerušit tlačítkem </span><strong><span>Cancel</span></strong><span> nebo zavřením okna. Dole můžete vidět seznam chyb, které při výpočtu nastaly. Až výpočet skončí, zobrazí se stav </span><strong><span>done</span></strong><span> a okno můžete zavřít.</span></p><h2 id='vývojová-dokumentace'><span>Vývojová dokumentace</span></h2><p><span>Následuje vývojová dokumentace pro programátory, která shrnuje nejdůležitější problémy a slouží jako úvod před ponořením se do zdrojového kódu aplikace. Nedílnou součástí jsou i komentáře v kódu, které mohou detailněji popisovat jednotlivé třídy a jejich metody.</span></p><h3 id='struktura-programu'><span>Struktura programu</span></h3><p><span>Program je dohromady složen z 5 projektů, z toho jeden je projekt </span><a href='https://xunit.net/'><span>xUnit</span></a><span> s testy a jeden je projekt benchmarků s použitím knihovny </span><a href='https://benchmarkdotnet.org/'><span>BenchmarkDotNet</span></a><span>.</span></p><p><span>Zbývající 3 projekty už přispívají ke kódu editoru:</span></p><ul><li><a href='#projekt-imagefilters'><span>ImageFilters</span></a><span> - knihovna pro image processing.</span></li><li><a href='#projekt-batchimageeditor'><span>BatchImageEditor</span></a><span> - editor pro dávkovou úpravu obrázků využívající knihovnu </span><em><span>ImageFilters</span></em><span>.</span></li><li><span>ThrowHelpers - knihovna obsahující pomocné třídy pro vyhazování výjimek. Není nijak zvlášť důležitá, proto nebude dále zmíněna.</span></li></ul><h3 id='projekt-imagefilters'><span>Projekt ImageFilters</span></h3><p><span>Účelem knihovny ImageFilters je zpracování obrázků pomocí filtrů. Tyto operace mohou být velmi náročné a jedním z hlavních problémů bylo právě balancování rozšiřitelnosti a výkonu.</span></p><p><span>Tento projekt mimo jiné obsahuje třídy pro paralelní zpracování obrázků. Na jediný obrázek se musí filtry aplikovat sekvenčně jeden za druhým. Pokud je obrázků více, může být seznam filtrů aplikován na každý z nich ve stejnou chvíli.</span></p><h4 id='filtry'><span>Filtry</span></h4><p><span>Pro kompatibilitu s </span><em><span>Windows Forms</span></em><span> byly použity třídy a struktury ze jmenného prostoru </span><a href='https://docs.microsoft.com/en-us/dotnet/api/system.drawing?view=net-5.0'><code>System.Drawing</code></a><span>. V něm je obrázek reprezentován třídou </span><a href='https://docs.microsoft.com/en-us/dotnet/api/system.drawing.bitmap?view=net-5.0'><code>Bitmap</code></a><span>, ale přístup k jejím datům pomocí metod </span><code>GetPixel</code><span> a </span><code>SetPixel</code><span> je velmi pomalý. Pro náročné operace jsou k dispozici metody </span><code>LockBits</code><span> a </span><code>UnlockBits</code><span>, které zabrání garbage collectoru přesouvat data obrázku a umožní tak přístup pomocí pointerů. Nakonec bylo použito řešení ze </span><a href='https://stackoverflow.com/a/34801225/13555057'><span>stackoverflow</span></a><span>, které zavádí třídu </span><code>DirectBitmap</code><span> s přímým přístupem k datům v bufferu. Tento způsob je jednodušší a dokonce i rychlejší než zamykání, což bylo vyzkoušeno v projektu s benchmarky.</span></p><p><span>Důležitým rozhraním je </span><code>IImageFilter</code><span>, které předepisuje jedinou funkci </span><code>void Apply(ref DirectBitmap image)</code><span> V některých případech je nutné vytvořit obrázek nový a starý smazat, jindy stačí operaci vykonat přímo na vstupním obrázku. Aby bylo jasné, že zavoláním této funkce se vzdáváme obrázku, je předáván jako reference. Všechny filtry implementují rozhraní </span><code>IImageFilter</code><span>.</span></p><p><span>Některé filtry, např. </span><code>ResizingFilter</code><span>, používají návrhový vzor </span><a href='https://en.wikipedia.org/wiki/Strategy_pattern'><span>Strategy</span></a><span>. Je definováno rozhraní reprezentující algoritmus, který se nějakým způsobem použije na filtrování obrázku. Pro změnu velikosti je to např. </span><code>IResizingAlgorithm</code><span>, který podle vstupního obrázku spočítá jeho výstupní velikost. Toto rozhraní implementují </span><code>FixedResizing</code><span> a </span><code>ResizingByFactor</code><span>, které počítají novou velikost jako fixní počet pixelů, respektive jako násobek staré velikosti.</span></p><p><span>Jiné filtry jsou rozšiřitelné pomocí dědičnosti. To platí pro </span><code>LinearFilter</code><span>, jehož potomci mají společné to, že definují matici vah, která je jako okno &quot;přiložena&quot; na pixel. Výstupní barva tohoto pixelu bude spočítána jako součet barev pixelů vynásobených přiloženými vahami. Odvozené třídy volají metodu </span><code>SetKernel</code><span>, čímž danou matici nastaví.</span></p><p><span>Filtry, u kterých se další rozšíření nepředpokládá, ale u kterých je potřeba rozlišit způsob chování, mají na vstupu hodnotu typu </span><code>enum</code><span>. Pro převrácení obrázku (</span><code>FlipFilter</code><span>) je to například typ </span><code>FlipType</code><span> s hodnotami </span><code>Horizontal</code><span>, </span><code>Vertical</code><span> a </span><code>Both</code><span>.</span></p><h4 id='paralelní-zpracování-obrázků'><span>Paralelní zpracování obrázků</span></h4><p><span>Třídy pro zpracování obrázků byly vytvořeny s vědomím, že budou výsledky průběžně hlášeny uživateli, a tomu byly také přizpůsobeny.</span></p><p><span>Třída </span><code>ImageProcessingJob</code><span> představuje úlohu na zpracování obrázku, která zahrnuje i jeho načtení a uložení. Tento proces může být zrušen, čehož je dosaženo pomocí delegátů (</span><code>Func&lt;bool&gt; ShouldCancelFunc</code><span>), kterých se třída průběžně dotazuje. Místo toho, aby při chybách vznikaly výjimky, jsou spouštěny delegáty pro selhání s chybovou zprávou a také úspěch, pokud výpočet bez problémů doběhl až do konce.</span></p><p><span>Úlohy jsou paralelizovány pomocí třídy </span><code>BatchProcessor</code><span>, která volá metodu </span><a href='https://docs.microsoft.com/en-us/dotnet/api/system.threading.tasks.parallel.foreach?view=net-5.0'><code>System.Threading.Tasks.Parallel.Foreach</code></a><span> na kolekci </span><code>ImageProcessingJob</code><span>.</span></p><h4 id='stará-řešení-a-jiné-poznámky'><span>Stará řešení a jiné poznámky</span></h4><p><code>DirectBitmap</code><span> byla dříve implementována také pomocí návrhového vzoru </span><code>Strategy</code><span> za účelem rozšíření pro různé formáty pixelu (</span><a href='https://docs.microsoft.com/en-us/dotnet/api/system.drawing.imaging.pixelformat?view=net-5.0'><code>System.Drawing.Imaging.PixelFormat</code></a><span>). </span><code>DirectBitmap</code><span> byla vytvořena z instance </span><code>Bitmap</code><span> a v jejím konstruktoru byl zvolen algoritmus (strategy), který z pozice v bufferu bytů dokázal najít a spočítat barvu pixelu. Tento postup se ukázal jako příliš komplikovaný a značně zpomaloval výpočty, především kvůli volání funkce z </span><code>interface</code><span> pro každý pixel. </span><code>DirectBitmap</code><span> proto používá jediný formát, na který je obrázek převeden a po zpracování se převede zpátky na původní.</span></p><p><code>ColorAdjustingFilter</code><span> používá </span><code>IColorAdjuster</code><span> pro výpočet nové barvy pixelu z pouhé znalosti jeho staré barvy. I tady se ukazuje vzor Strategy jako přehnaný, protože třída </span><code>ColorAdjustingFilter</code><span> není vůbec složitá a ušetření kódu tímto způsobem je zanedbatelné.</span></p><h3 id='projekt-batchimageeditor'><span>Projekt BatchImageEditor</span></h3><p><span>Delší čas jsem strávil rozhodováním, jaký návrh vybrat pro editor. Hlavním kandidátem byl návrhový vzor </span><a href='https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93presenter'><span>MVP</span></a><span>, ale nepodařilo se mi vymyslet, jak jednotlivé komponenty propojit. Nakonec jsem se rozhodl komponenty rozdělit do samostatných </span><a href='https://docs.microsoft.com/en-us/dotnet/api/system.windows.controls.usercontrol?view=net-5.0'><code>UserControl</code></a><span>, kde vnější </span><code>UserControl</code><span> ovládá pomocí rozhraní další </span><code>UserControl</code><span>-s, která sama vlastní. Tímto způsobem je hlavní formulář rozdělen na scény, které jsou dále děleny na další samostatné části. Některé komponenty tak mohly být použity na více různých místech, jako například náhled obrázku.</span></p><h4 id='nastavení-filtrů'><span>Nastavení filtrů</span></h4><p><span>Jedním z problémů bylo propojení knihovny </span><code>ImageFilters</code><span> a umožnění uživateli jednotlivé filtry nastavovat. Nastavení musí být uložena v polymorfním seznamu, kde jsou připravena na další úpravu.</span></p><p><span>Všechna nastavení byla vytvořena jako </span><code>UserControl</code><span>-s se společným rozhraním definovaným v abstraktní třídě </span><code>FilterSettingsBase</code><span> a společnou implementací (částečnou) v odvozené generické třídě </span><code>FilterSettings&lt;TModel&gt;</code><span>. Každé nastavení obsahuje </span><em><span>model</span></em><span>, ve kterém jsou uložena data nutná pro vytvoření filtru. Tyto modely mají společné rozhraní </span><code>IFilterSettingsModel&lt;TModel&gt;</code><span>, které jim předepisuje funkci </span><code>IEnumerable&lt;IImageFilter&gt; CreateFilters()</code><span>. Pokud je nastavení filtru potvrzeno uživatelem, model se uloží a nastavení (</span><code>UserControl</code><span>) se začlení do seznamu, kde je připraveno na další použití.</span></p><p><span>Toto řešení má háček v tom, že kvůli abstraktním a generickým předkům (</span><code>FilterSettingsBase</code><span> a </span><code>FilterSettings&lt;TModel&gt;</code><span>) nelze nastavení zobrazit v designeru </span><em><span>Visual Studia</span></em><span>. Provizorním řešením je při práci s designerem předka dočasně nahradit za </span><code>UserControl</code><span>. </span></p><p><span>Při testování aplikace na různých počítačích vyvstaly problémy s rozlišením. Ty byly vyřešeny uzavřením komponent do </span><code>Panel</code><span>-ů, kterým byla nastavena vlastnost </span><code>Dock</code><span> na hodnotu jinou než </span><code>None</code><span>.</span></p><h4 id='paralelní-výpočty-v-ui'><span>Paralelní výpočty v UI</span></h4><p><span>Za zmínku stojí třída </span><code>UIUpdater</code><span>, která byla použita pro asynchronní výpočet náhledu obrázku. Pokaždé, když uživatel změní seznam filtrů nebo nastavení jednoho z nich, vytvoří se nový obrázek, na který se aplikují všechny filtry a výsledek se ukáže v náhledu. Tato operace může být drahá už při použití jednoho filtru, natož ve chvíli, kdy uživatel pracuje s větším množstvím filtrů. Proto je žádoucí, aby se neprováděla sekvenčně, čímž by brzdila celou aplikaci. Aktualizace nemohou být spouštěny nezávisle. Musí být totiž zajištěno, že nová úloha nepředběhne starší, jinak bychom v náhledu viděli nejprve novější a poté starší obrázek. Řešením není jednoduchá fronta čekajících </span><a href='https://docs.microsoft.com/en-us/dotnet/api/system.threading.tasks.task?view=net-5.0'><span>Task</span></a><span>-ů, protože ta by mohla narůstat rychleji, než by se úlohy stačily dokončovat - například při rychlé změně výšky a šířky obrázku.</span></p><p><code>UIUpdater</code><span> spouští najednou pouze 1 aktualizaci a ukládá si 1-prvkovou čekající frontu. Pro začlenění nové aktualizace do &quot;fronty&quot; vyžaduje </span><code>UIUpdater</code><span> funkci (delegáta), která vrací </span><code>Task</code><span>. Tento </span><code>Task</code><span> už musí být rozdělený na paralelní část (výpočet náhledu) a sekvenční část (ukázání náhledu v okně) volajícím pomocí </span><em><span>pokračování</span></em><span> (</span><a href='https://docs.microsoft.com/en-us/dotnet/api/system.threading.tasks.task.continuewith?view=net-5.0'><span>continuations</span></a><span>). Při prvním zavolání se tento </span><code>Task</code><span> spustí a nyní běží jeho paralelní část v pozadí. Uživatel provedl změnu a </span><code>UIUpdater</code><span> je požádán o začlenění nové aktualizace. První </span><code>Task</code><span> ale stále běží, proto je delegát na výrobu druhého </span><code>Task</code><span>-u uložen do proměnné jako </span><em><span>čekající úloha</span></em><span>. Uživatel opět provedl změnu a </span><code>UIUpdater</code><span> je potřetí dotázán o začlenění nové aktualizace, přičemž ta první stále není hotová. Tato třetí úloha se zapíše do čekací fronty a tím se zahodí druhá úloha. Nyní konečně skončila první aktualizace. V jejím </span><em><span>pokračování</span></em><span> se kontroluje, jestli je nějaká úloha v čekací frontě. Protože třetí úloha je zapsána jako </span><em><span>čekající</span></em><span>, je v tomto pokračování spuštěna a čekací místo se uvolní pro další úlohu.</span></p><h4 id='poznámky-k-návrhu'><span>Poznámky k návrhu</span></h4><p><span>Návrh editoru se postupem času ukázal jako nevhodný, protože je z velké části špatně testovatelný a chyby se v něm velmi špatně odhalovaly. Lepším návrhem by byl zmíněný MVP, který odděluje konkrétní pohled (</span><em><span>View</span></em><span>) od jeho prezentační logiky (</span><em><span>Presenter</span></em><span>) a dat (</span><em><span>Model</span></em><span>). Musela by ale být nějakým způsobem vyřešena komunikace mezi jednotlivými Presentery a také vnoření jednotlivých </span><em><span>MVP</span></em><span> celků. Kupříkladu scéna obsahuje další komponenty, se kterými musí komunikovat, případně i dané komponenty musí komunikovat mezi sebou.</span></p><h2 id='pohled-zpět-a-možná-vylepšení'><span>Pohled zpět a možná vylepšení</span></h2><p><span>Cílem tohoto projektu bylo procvičení více-vláknového programování a malý výlet do světa UI a grafiky. Z mého pohledu jsem splnil původní zadání specifikace, ale ukázalo se, že moje nároky byly příliš vysoké a nedostal jsem se k některým pokročilejším prvkům.</span></p><p><span>Ačkoliv jsem se domníval, že pro image processing budu používat </span><code>Task</code><span>-y, po zvážení jsem naprogramoval filtry sekvenčně a nechal jsem </span><code>BatchProcessor</code><span> výpočet zparalelizovat pomocí </span><code>Parallel.Foreach</code><span>. </span><code>Task</code><span>-y se mi poté hodily až pro uživatelské rozhraní.</span></p><p><span>Chtěl jsem vytvořit vhodný návrh pro UI, což se mi nepodařilo a skončil jsem s rozdělením na </span><code>UserControl</code><span>-s. Pro lepší rozšiřitelnost a testovatelnost by bylo zapotřebí komplexnějšího návrhu.</span></p><p><span>Původně jsem se chtěl dostat k zajímavějším obrázkovým filtrům, například k ostření nebo různým efektům jako je olejomalba. Překvapilo mě, jak jsou pokročilejší filtry komplikované a dostupnými zdroji bývají spíše vědecké práce. Nakonec mi na přidávání těchto zajímavějších filtrů nezbyl čas.</span></p><p><span>Mezi možné způsoby, jak program vylepšit, patří:</span></p><ul><li><p><span>Vložení textu do obrázku.</span></p></li><li><p><span>Efekty:</span></p><ul><li><span>Olejomalba, mozaika, emboss, ...</span></li><li><span>Uživatelem definovaný lineární filtr (matice).</span></li></ul></li><li><p><span>Masky pro ořezávání složitějších tvarů z obrázku.</span></p></li><li><p><span>Uložení seznamu filtrů jako šablony, která může být načtena a použita znovu.</span></p></li><li><p><span>Přejmenování obrázků podle data poslední změny, pořadí ve složkách, nebo jiným způsobem.</span></p></li><li><p><span>Dodávání nových filtrů pomocí pluginů.</span></p></li></ul></div></div>
</body>
</html>